# Secure Secret Management

The DataShield Helm chart has been updated to implement secure secret management. This document explains how to configure and use the new secret system.

## Overview

The chart now supports two modes of secret management:

1. **Automatic Secret Generation**: Random 16-character alphanumeric secrets are generated by Helm when no external secrets are provided.
2. **External Secret References**: You can reference existing Kubernetes secrets created outside of the Helm chart.

## Important Security Notes

- **No plaintext secrets in values.yaml**: The chart no longer accepts plaintext passwords in the values.yaml file.
- **Random secret generation**: When no external secrets are provided, the chart generates secure random secrets.
- **Existing secret support**: You can provide references to pre-created Kubernetes secrets.

## Configuration

### Automatic Secret Generation (Default)

By default, the chart will generate random secrets for all enabled components. No additional configuration is required.

Example `values.yaml` (using auto-generated secrets):
```yaml
mongodb:
  enabled: true
  auth:
    enabled: true
    # existingSecret: ""  # Leave empty for auto-generation
    database: "mongodb"

mysql:
  enabled: true
  auth:
    # existingSecret: ""  # Leave empty for auto-generation
    database: "dsdb"
    username: "dsdb_user"

opal:
  enabled: true
  config:
    # existingSecret: ""  # Leave empty for auto-generation
    
rock:
  enabled: true
  config:
    # existingSecret: ""  # Leave empty for auto-generation
```

### Using External Secrets

To use existing Kubernetes secrets, specify the secret name in the `existingSecret` field:

```yaml
mongodb:
  enabled: true
  auth:
    enabled: true
    existingSecret: "my-mongodb-secret"
    database: "mongodb"

mysql:
  enabled: true
  auth:
    existingSecret: "my-mysql-secret"
    database: "dsdb"
    username: "dsdb_user"

opal:
  enabled: true
  config:
    existingSecret: "my-opal-secret"
    
rock:
  enabled: true
  config:
    existingSecret: "my-rock-secret"
```

## Required Secret Keys

When creating external secrets, ensure they contain the following keys:

### MongoDB Secret Keys
- `mongodb-root-password`: Root password for MongoDB
- `mongodb-username`: Username for application access
- `mongodb-password`: Password for application user
- `mongodb-database`: Database name

### MySQL Secret Keys
- `mysql-root-password`: Root password for MySQL
- `mysql-username`: Username for application access
- `mysql-password`: Password for application user
- `mysql-database`: Database name

### Opal Secret Keys
- `opal-administrator-password`: Administrator password for Opal

### Opal Demo Secret Keys
- `opal-demo-user-password`: Demo user password for Opal

### Rock Secret Keys
- `rock-administrator-password`: Administrator password for Rock
- `rock-manager-password`: Manager password for Rock
- `rock-user-password`: User password for Rock

### Agate Secret Keys
- `agate-administrator-password`: Administrator password for Agate

### Mica Secret Keys
- `mica-administrator-password`: Administrator password for Mica

## Creating External Secrets

### Example: Creating a MongoDB secret

```bash
kubectl create secret generic my-mongodb-secret \
  --from-literal=mongodb-root-password=my-secure-root-password \
  --from-literal=mongodb-username=mongodb_user \
  --from-literal=mongodb-password=my-secure-user-password \
  --from-literal=mongodb-database=mongodb
```

### Example: Creating a MySQL secret

```bash
kubectl create secret generic my-mysql-secret \
  --from-literal=mysql-root-password=my-secure-root-password \
  --from-literal=mysql-username=dsdb_user \
  --from-literal=mysql-password=my-secure-user-password \
  --from-literal=mysql-database=dsdb
```

### Example: Creating an Opal secret

```bash
kubectl create secret generic my-opal-secret \
  --from-literal=opal-administrator-password=my-secure-admin-password
```

### Example: Creating a Rock secret

```bash
kubectl create secret generic my-rock-secret \
  --from-literal=rock-administrator-password=my-secure-admin-password \
  --from-literal=rock-manager-password=my-secure-manager-password \
  --from-literal=rock-user-password=my-secure-user-password
```

## Migration from Previous Versions

If you're upgrading from a previous version where secrets were stored in plaintext in `values.yaml`:

1. **Remove plaintext passwords**: Remove any plaintext password values from your `values.yaml` file.
2. **Choose your approach**:
   - **Option A**: Let the chart generate random secrets (recommended for new deployments)
   - **Option B**: Create external secrets with your existing passwords and reference them

### Migration Example

**Old values.yaml (insecure):**
```yaml
mysql:
  auth:
    rootPassword: "my-root-password"
    username: "dsdb_user"
    password: "my-user-password"
    database: "dsdb"
```

**New values.yaml (secure):**
```yaml
mysql:
  auth:
    existingSecret: "my-mysql-secret"  # Reference to external secret
    username: "dsdb_user"
    database: "dsdb"
```

## Accessing Generated Secrets

To retrieve automatically generated secrets:

```bash
# Get the secret name (usually <release-name>-datashield-secrets)
kubectl get secrets

# Decode a specific secret value
kubectl get secret <release-name>-datashield-secrets -o jsonpath='{.data.mysql-root-password}' | base64 --decode
```

## Best Practices

1. **Use external secrets for production**: For production deployments, create secrets outside of Helm and reference them.
2. **Rotate secrets regularly**: Regularly update your secrets for better security.
3. **Use secret management tools**: Consider using tools like Sealed Secrets, External Secrets Operator, or cloud-native secret management services.
4. **Monitor secret access**: Implement monitoring and alerting for secret access.
5. **Backup secrets**: Ensure your secrets are included in your backup and disaster recovery plans.

## Troubleshooting

### Common Issues

1. **Missing secret keys**: Ensure your external secrets contain all required keys.
2. **Secret not found**: Verify the secret name and namespace are correct.
3. **Permission issues**: Ensure the service account has permission to access the secrets.

### Debugging Commands

```bash
# Check if secrets exist
kubectl get secrets

# Describe a secret (shows keys but not values)
kubectl describe secret <secret-name>

# Check pod logs for secret-related errors
kubectl logs <pod-name>

# Check if secret is mounted correctly
kubectl describe pod <pod-name>
```
